import test from "tape"
import * as jsonHelper from "../src/json-helper.js"

test("jsonHelper.deepEqual", (t) => {
  t.ok(jsonHelper.deepEqual({}, {}), "emptry objects")
  t.ok(jsonHelper.deepEqual([], new Float32Array()), "empty arrays")
  t.ok(jsonHelper.deepEqual(1, 1), "numbers")
  t.notOk(jsonHelper.deepEqual([1], [1,2]), "different size arrays")
  t.notOk(jsonHelper.deepEqual([1,2], [1]), "different size arrays II")
  t.notOk(jsonHelper.deepEqual({x:1}, {y:2,x:1}), "different size objects")
  t.notOk(jsonHelper.deepEqual({x:1,y:2}, {y:2}), "different size objects II")
  t.notOk(jsonHelper.deepEqual("a", "b"), "different strings")
  t.ok(jsonHelper.deepEqual(new Float32Array(3).fill(6), [6,6,6]), "float array vs array, same content")
  t.end()
})


test("jsonHelper.getWithPath", (t) => {
  t.equals(jsonHelper.getWithPath({a: 1, b: {c: {x: "hello"}, d: 3}}, ["b","c","x"]), "hello", "valid leaf")
  t.equals(jsonHelper.getWithPath({a: 1, b: {c: {x: "hello"}, d: 3}}, ["b","c","y"]), undefined, "invalid leaf")
  t.equals(jsonHelper.getWithPath({a: 1, b: {c: {x: "hello"}, d: 3}}, ["a"]), 1, "valid first level")
  t.equals(jsonHelper.getWithPath({a: 1, b: {c: {x: "hello"}, d: 3}}, ["b","w"]), undefined, "invalid branch")
  t.equals(jsonHelper.getWithPath(undefined, undefined), undefined, "undefined")
  t.equals(jsonHelper.getWithPath(1, []), 1, "a number")
  t.equals(jsonHelper.getWithPath("house", []), "house", "a string")
  t.end()
})

test("jsonHelper.deepCopy", (t) => {
  t.deepEqual(jsonHelper.deepCopy(""), "", "empty string")
  t.deepEqual(jsonHelper.deepCopy(1), 1, "number")
  t.deepEqual(jsonHelper.deepCopy([]), [], "empty array")
  t.deepEqual(jsonHelper.deepCopy({}), {}, "empty object")
  t.deepEqual(jsonHelper.deepCopy({a:1, b:"hello", c:undefined}), {a:1, b:"hello", c:undefined}, "object")
  t.deepEqual(jsonHelper.deepCopy([1,"help",false]), [1,"help",false], "array")
  t.deepEqual(jsonHelper.deepCopy({x: [1,"help",false], y: 2}), {x: [1,"help",false], y: 2}, "object with array")
  t.end()
})

test("jsonHelper.query", (t) => {
  t.deepEqual(jsonHelper.query(undefined, () => (t.fail('undefined should never query'), false), () => t.fail('undefined should never output')), undefined, 'undefined')
  t.deepEqual(jsonHelper.query(null, () => (t.fail('null should never query'), false), () => t.fail('null should never output')), undefined, 'null')
  t.deepEqual(jsonHelper.query([], () => false, () => t.fail('empty array should never output')), undefined, 'empty array')
  t.deepEqual(jsonHelper.query({}, () => false, () => t.fail('empty object should never output')), undefined, 'empty object')
  t.deepEqual(jsonHelper.query( [{a:1},{a:2},{a:3}] , q => q.a >= 2), {a:2}, 'array of simple objects')
  t.deepEqual(jsonHelper.query( [{a:1},{a:2},{a:3}] , q => q.a >= 2, d => d.a), 2, 'array of simple objects, with feature extraction')
  t.deepEqual(jsonHelper.query( {u: [0], x: {b:1, c:1}, y: {c:3} } , q => 'b' in q), {b:1, c:1}, 'nested objects, check for property')
  t.deepEqual(jsonHelper.query( {u: [0], x: [{b:1, c:1}, {b:2, c:2}], y: {b:3, c:3} } , q => 'b' in q), {b:1, c:1}, 'multiple nested objects, check for property')
  t.deepEqual(jsonHelper.query( [ [1,2,3], [4,5,6,7], [8,9,10], [11] ] , q => q.length === 3), [1,2,3], 'nested arrays, check length')
  t.end()
})

test("jsonHelper.queryAll", (t) => {
  t.deepEqual(jsonHelper.queryAll(undefined, () => (t.fail('undefined should never query'), false), () => t.fail('undefined should never output')), [], 'undefined')
  t.deepEqual(jsonHelper.queryAll(null, () => (t.fail('null should never query'), false), () => t.fail('null should never output')), [], 'null')
  t.deepEqual(jsonHelper.queryAll([], () => false, () => t.fail('empty array should never output')), [], 'empty array')
  t.deepEqual(jsonHelper.queryAll({}, () => false, () => t.fail('empty object should never output')), [], 'empty object')
  t.deepEqual(jsonHelper.queryAll( [{a:1},{a:2},{a:3}] , q => q.a >= 2), [{a:2}, {a:3}], 'array of simple objects')
  t.deepEqual(jsonHelper.queryAll( [{a:1},{a:2},{a:3}] , q => q.a >= 2, d => d.a), [2,3], 'array of simple objects, with feature extraction')
  t.deepEqual(jsonHelper.queryAll( {x: {b:1, c:1}, y: {c:3} } , q => 'b' in q), [{b:1, c:1}], 'nested objects, check for property')
  t.deepEqual(jsonHelper.queryAll( {x: [{b:1, c:1}, {b:2, c:2}], y: {b:3, c:3} } , q => 'b' in q), [{b:1, c:1}, {b:2, c:2}, {b:3, c:3}], 'multiple nested objects, check for property')
  t.deepEqual(jsonHelper.queryAll( [ [1,2,3], [4,5,6,7], [8,9,10], [11] ] , q => q.length === 3), [ [1,2,3], [8,9,10] ], 'nested arrays, check length')
  t.deepEqual(jsonHelper.queryAll( [ [1,2,3], [4,5,6,7], [8,9,10], [11] ] , q => q.length === 5), [], 'nested arrays, check length, no matches')
  t.end()
})

test("jsonHelper.countAll", (t) => {
  t.deepEqual(jsonHelper.countAll( undefined, () => (t.fail('undefined should never query'), false) ), 0, 'undefined')
  t.deepEqual(jsonHelper.countAll( null, () => (t.fail('null should never query'), false) ), 0, 'null')
  t.deepEqual(jsonHelper.countAll( [], () => false ), 0, 'empty array')
  t.deepEqual(jsonHelper.countAll( {}, () => false ), 0, 'empty object')
  t.deepEqual(jsonHelper.countAll( [{a:1},{a:2},{a:3}] , q => q.a >= 2), 2, 'array of simple objects')
  t.deepEqual(jsonHelper.countAll( {x: {b:1, c:1}, y: {c:3} } , q => 'b' in q), 1, 'nested objects, check for property')
  t.deepEqual(jsonHelper.countAll( {x: [{b:1, c:1}, {b:2, c:2}], y: {b:3, c:3} } , q => 'b' in q), 3, 'multiple nested objects, check for property')
  t.deepEqual(jsonHelper.countAll( [ [1,2,3], [4,5,6,7], [8,9,10], [11] ] , q => q.length === 3), 2, 'nested arrays, check length')
  t.deepEqual(jsonHelper.countAll( [ [1,2,3], [4,5,6,7], [8,9,10], [11] ] , q => q.length === 5), 0, 'nested arrays, check length, no matches')
  t.end()
})

test("jsonHelper.map", (t) => {
  t.deepEqual(jsonHelper.map( undefined, () => 1), 1, 'undefined')
  t.deepEqual(jsonHelper.map( [], () => 1 ), [], 'empty array')
  t.deepEqual(jsonHelper.map( {}, () => 1 ), {}, 'empty record')
  t.deepEqual(jsonHelper.map( "", () => 1 ), 1, 'empty string')
  t.deepEqual(jsonHelper.map( [1,-2,3], (x) => x*2 ), [2,-4,6], 'array')
  t.deepEqual(jsonHelper.map( {a:1, b:-2, c:3}, (x) => x*2 ), {a:2, b:-4, c:6}, 'record')
  t.deepEqual(jsonHelper.map( {x: [1,2,{i: 4, j: -1}], y: {a: 3, b: 4}}, (x) => x*2 ), {x: [2,4,{i: 8, j: -2}], y: {a: 6, b: 8}}, 'records and arrays')
  t.end()
})

test("jsonHelper.diff", (t) => {
  t.deepEqual(jsonHelper.diff(undefined, undefined), undefined, 'undefined')
  t.deepEqual(jsonHelper.diff(undefined, 1), {added: [[]]}, 'added a number')
  t.deepEqual(jsonHelper.diff(undefined, "b"), {added: [[]]}, 'added a string')
  t.deepEqual(jsonHelper.diff(2, undefined), {deleted: [[]]}, 'removed a number')
  t.deepEqual(jsonHelper.diff("cat", undefined), {deleted: [[]]}, 'removed a string')
  t.deepEqual(jsonHelper.diff([], [1]), {added: [[0]]}, 'added to an emtpy array')
  t.deepEqual(jsonHelper.diff([1], [1,2]), {added: [[1]]}, 'added to an array')
  t.deepEqual(jsonHelper.diff([1,2], [2,1]), {updated: [[0], [1]]}, 'swapped array elements')
  t.end()
})